<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Quản Lý Thông Báo</h1>
</div>

<!-- Alert Messages -->
<div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong>Lỗi!</strong> {{ errorMessage }}
    <button type="button" class="close" (click)="errorMessage = ''" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
    <strong>Thành công!</strong> {{ successMessage }}
    <button type="button" class="close" (click)="successMessage = ''" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<!-- Form Card -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-paper-plane mr-2"></i>Gửi Thông Báo
        </h6>
    </div>
    <div class="card-body">
        <form (ngSubmit)="sendNotice()">
            <!-- Nội dung thông báo -->
            <div class="form-group">
                <label for="noiDung">Nội Dung Thông Báo <span class="text-danger">*</span></label>
                <textarea 
                    class="form-control" 
                    [class.is-invalid]="isOverLimit"
                    id="noiDung" 
                    rows="5"
                    [(ngModel)]="noiDung"
                    (input)="onNoiDungChange()"
                    name="noiDung"
                    [maxlength]="maxLength"
                    required
                    placeholder="Nhập nội dung thông báo..."></textarea>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small [class.text-danger]="isOverLimit" [class.text-muted]="!isOverLimit">
                        <span *ngIf="isOverLimit" class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i> Đã vượt quá giới hạn!
                        </span>
                    </small>
                    <small [class.text-danger]="remainingChars < 50" [class.text-muted]="remainingChars >= 50">
                        {{ noiDung.length }}/{{ maxLength }} ký tự
                    </small>
                </div>
            </div>

            <!-- Loại gửi -->
            <div class="form-group">
                <label>Gửi đến</label>
                <div class="form-check">
                    <input 
                        class="form-check-input" 
                        type="radio" 
                        name="sendType" 
                        id="sendAll"
                        value="all"
                        [(ngModel)]="sendType"
                        (change)="onSendTypeChange()">
                    <label class="form-check-label" for="sendAll">
                        Tất cả tài khoản
                    </label>
                </div>
                <div class="form-check">
                    <input 
                        class="form-check-input" 
                        type="radio" 
                        name="sendType" 
                        id="sendByRole"
                        value="byRole"
                        [(ngModel)]="sendType"
                        (change)="onSendTypeChange()">
                    <label class="form-check-label" for="sendByRole">
                        Theo vai trò
                    </label>
                </div>
                <div class="form-check">
                    <input 
                        class="form-check-input" 
                        type="radio" 
                        name="sendType" 
                        id="sendSpecific"
                        value="specific"
                        [(ngModel)]="sendType"
                        (change)="onSendTypeChange()">
                    <label class="form-check-label" for="sendSpecific">
                        Tài khoản cụ thể
                    </label>
                </div>
            </div>

            <!-- Vai trò (chỉ hiện khi chọn "Theo vai trò" hoặc "Tài khoản cụ thể") -->
            <div *ngIf="sendType === 'byRole' || sendType === 'specific'" class="form-group">
                <label for="targetRole">Vai Trò <span class="text-danger">*</span></label>
                <select 
                    class="form-control" 
                    id="targetRole"
                    [(ngModel)]="targetRole"
                    name="targetRole"
                    (change)="onTargetRoleChange()"
                    required>
                    <option value="">-- Chọn vai trò --</option>
                    <option value="Admin">Admin</option>
                    <option value="NhanVien">Nhân Viên</option>
                    <option value="DocGia">Người Đọc</option>
                </select>
            </div>

            <!-- Chọn tài khoản cụ thể (chỉ hiện khi sendType = specific) -->
            <div *ngIf="sendType === 'specific' && targetRole" class="form-group">
                <label for="selectedAccount">Chọn Tài Khoản <span class="text-danger">*</span></label>
                <div *ngIf="loading" class="text-muted">
                    <i class="fas fa-spinner fa-spin mr-1"></i>Đang tải danh sách...
                </div>
                <select 
                    *ngIf="!loading"
                    class="form-control" 
                    id="selectedAccount"
                    [(ngModel)]="selectedAccountId"
                    name="selectedAccount"
                    [required]="sendType === 'specific'">
                    <option [value]="null">-- Chọn tài khoản --</option>
                    <option *ngFor="let account of accounts" [value]="account.maTk">
                        {{ account.hoTen || account.tenDangNhap }} ({{ account.tenDangNhap }})
                    </option>
                </select>
                <small *ngIf="!loading && accounts.length === 0" class="text-muted">
                    Không có tài khoản nào trong vai trò này.
                </small>
            </div>

            <!-- Thông tin gửi -->
            <div *ngIf="sendType === 'all'" class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i>
                Thông báo sẽ được gửi đến <strong>tất cả</strong> tài khoản trong hệ thống.
            </div>
            <div *ngIf="sendType === 'byRole' && targetRole" class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i>
                Thông báo sẽ được gửi đến <strong>tất cả</strong> tài khoản có vai trò <strong>{{ targetRole }}</strong>.
            </div>

            <!-- Submit Button -->
            <div class="form-group mt-4">
                <button 
                    type="submit" 
                    class="btn btn-primary"
                    [disabled]="loading">
                    <span *ngIf="loading" class="spinner-border spinner-border-sm mr-2"></span>
                    <i class="fas fa-paper-plane mr-2"></i>
                    {{ loading ? 'Đang gửi...' : 'Gửi Thông Báo' }}
                </button>
                <button 
                    type="button" 
                    class="btn btn-secondary ml-2"
                    (click)="resetForm()"
                    [disabled]="loading">
                    <i class="fas fa-redo mr-2"></i>Làm Mới
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Hướng dẫn -->
<div class="card shadow mb-4">
    <div class="card-header py-3 bg-info text-white">
        <h6 class="m-0 font-weight-bold">
            <i class="fas fa-question-circle mr-2"></i>Hướng Dẫn
        </h6>
    </div>
    <div class="card-body">
        <ul class="mb-0">
            <li><strong>Gửi đến tất cả:</strong> Gửi thông báo cho tất cả tài khoản trong hệ thống (không cần chọn vai trò).</li>
            <li><strong>Gửi theo vai trò:</strong> Chọn vai trò (Admin, Nhân Viên, hoặc Người Đọc) để gửi thông báo cho tất cả tài khoản có vai trò đó.</li>
            <li><strong>Gửi đến tài khoản cụ thể:</strong> Chọn vai trò và sau đó chọn một tài khoản cụ thể để gửi thông báo.</li>
            <li>Thông báo sẽ được lưu trong hệ thống và người nhận có thể xem trong trang "Thông Báo" của họ.</li>
        </ul>
    </div>
</div>
