<main class="main">
<!-- Page Title -->
    <div class="page-title light-background">
      <div class="container d-lg-flex justify-content-between align-items-center">
        <h1 class="mb-2 mb-lg-0">Chi tiết sách</h1>
        <nav class="breadcrumbs">
          <ol>
            <li><a routerLink="/" routerLinkActive="active">Home</a></li>
            <li class="current">Product Details</li>
          </ol>
        </nav>
      </div>
    </div><!-- End Page Title -->

    <!-- Product Details Section -->
    <section id="product-details" class="product-details section">

      <div class="container" data-aos="fade-up" data-aos-delay="100">

        <div class="row g-4">
          <!-- Product Gallery -->
          <div class="col-lg-7" data-aos="zoom-in" data-aos-delay="150">
            <div class="product-gallery">
              <div class="main-showcase">
                <div class="image-zoom-container">
                  <img [src]="getImageUrl(sach?.maSach, 'jpg')"
                      alt="{{ sach?.tuaSach }}"
                      class="img-fluid main-product-image"
                      id="main-product-image"
                      [attr.data-zoom]="getImageUrl(sach?.maSach ?? 0, 'jpg')">

                  <!-- <div class="image-navigation">
                    <button class="nav-arrow prev-image image-nav-btn prev-image" type="button">
                      <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="nav-arrow next-image image-nav-btn next-image" type="button">
                      <i class="bi bi-chevron-right"></i>
                    </button>
                  </div> -->
                </div>
              </div>

              <!-- <div class="thumbnail-grid">
                <div class="thumbnail-wrapper thumbnail-item active" data-image="/assets/img/product/product-details-6.webp">
                  <img src="/assets/img/product/product-details-6.webp" alt="View 1" class="img-fluid">
                </div>
                <div class="thumbnail-wrapper thumbnail-item" data-image="/assets/img/product/product-details-7.webp">
                  <img src="/assets/img/product/product-details-7.webp" alt="View 2" class="img-fluid">
                </div>
                <div class="thumbnail-wrapper thumbnail-item" data-image="/assets/img/product/product-details-8.webp">
                  <img src="/assets/img/product/product-details-8.webp" alt="View 3" class="img-fluid">
                </div>
                <div class="thumbnail-wrapper thumbnail-item" data-image="/assets/img/product/product-details-4.webp">
                  <img src="/assets/img/product/product-details-4.webp" alt="View 4" class="img-fluid">
                </div>
                <div class="thumbnail-wrapper thumbnail-item" data-image="/assets/img/product/product-details-5.webp">
                  <img src="/assets/img/product/product-details-5.webp" alt="View 5" class="img-fluid">
                </div>
                <div class="thumbnail-wrapper thumbnail-item" data-image="/assets/img/product/product-details-3.webp">
                  <img src="/assets/img/product/product-details-3.webp" alt="View 6" class="img-fluid">
                </div>
              </div> -->
            </div>
          </div>

          <!-- Product Details -->
          <div class="col-lg-5" data-aos="fade-left" data-aos-delay="200">
            <div class="product-details">
              <div class="product-badge-container">
                <!-- <span class="badge-category">Audio Equipment</span> -->
                <div class="rating-group">
                  <div class="stars">
                    <ng-container *ngFor="let i of [1,2,3,4,5]">
                      <i
                        class="bi"
                        [ngClass]="{
                          'bi-star-fill': i <= averageRating,
                          'bi-star-half': i > averageRating && i - 0.5 <= averageRating,
                          'bi-star': i-0.5 > averageRating
                        }"
                      ></i>
                    </ng-container>
                  </div>
                  <span class="review-text">({{ totalReviews }} đánh giá)</span>
                </div>
              </div>

              <h1 class="product-name">{{ sach?.tuaSach }}</h1> 

              <div class="pricing-section">
                <div class="price-display">
                  <span class="sale-price">{{ sach?.tenTg }}</span>
                  <!-- <span class="regular-price">$239.99</span> -->
                </div>
                <div class="savings-info">
                  <!-- <span class="save-amount">Save $50.00</span> -->
                  <!-- <span class="discount-percent">(21% off)</span> -->
                </div>
              </div>

              <div class="product-description">
                 <p>{{ sach?.gioiThieu }}</p>
              </div> 

              <div class="availability-status">
                <div class="stock-indicator">
                  <i class="bi bi-check-circle-fill"></i>
                  <span class="stock-text">Số sách còn</span>
                </div>
                <div class="quantity-left">Chỉ còn {{ sach?.soLuong }} quyển</div>
              </div>

              <!-- Product Variants -->
              <!-- <div class="variant-section">
                <div class="color-selection">
                  <label class="variant-label">Available Colors:</label>
                  <div class="color-grid">
                    <div class="color-chip active" data-color="Midnight Black" style="background: linear-gradient(135deg, #1a1a1a, #000);">
                      <span class="selection-check"><i class="bi bi-check"></i></span>
                    </div>
                    <div class="color-chip" data-color="Pearl White" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                      <span class="selection-check"><i class="bi bi-check"></i></span>
                    </div>
                    <div class="color-chip" data-color="Ocean Blue" style="background: linear-gradient(135deg, #0066cc, #004499);">
                      <span class="selection-check"><i class="bi bi-check"></i></span>
                    </div>
                    <div class="color-chip" data-color="Forest Green" style="background: linear-gradient(135deg, #28a745, #155724);">
                      <span class="selection-check"><i class="bi bi-check"></i></span>
                    </div>
                  </div>
                  <div class="selected-variant">Selected: <span>Midnight Black</span></div>
                </div>
              </div> -->

              <!-- Purchase Options -->
              <div class="purchase-section">
                <div class="quantity-control">
                  <label class="control-label">Số lượng:</label>
                    <div class="quantity-input-group">
                      <div class="quantity-selector">
                        <button class="quantity-btn decrease" type="button" (click)="decreaseQuantity()">
                            <i class="bi bi-dash"></i>
                        </button>

                        <input type="number"
                           class="quantity-input no-arrow"
                           [(ngModel)]="quantity"
                           min="1"
                           max="sach?.soLuong">

                        <button class="quantity-btn increase" type="button" (click)="increaseQuantity()">
                             <i class="bi bi-plus"></i>
                        </button>
                      </div>
                    </div>
                </div>


                <div class="action-buttons">
                  <!-- <button class="btn primary-action">
                    <i class="bi bi-bag-plus"></i>
                    Mượn sách
                  </button> -->
                  <button class="btn secondary-action">
                    <i class="bi bi-book"></i>
                    Đặt sách
                  </button>
                  <!-- <button class="btn icon-action" title="Add to Wishlist">
                    <i class="bi bi-heart"></i>
                  </button> -->
                </div>
              </div>

              <!-- Benefits List -->
              <div class="benefits-list">
                <div class="benefit-item">
                 <i class="bi bi-book"></i>
                  <span>Đối tượng mượn là người có thẻ đa năng, sinh viên, giảng viên</span>
                </div>
                <div class="benefit-item">
                  <i class="bi bi-book"></i>
                  <span>Kiểm tra kỹ tình trạng tài liệu và báo cáo cho cán bộ thư viện nếu tài liệu bị rách, bị bẩn… trước khi mượn </span>
                </div>
                <div class="benefit-item">
                  <i class="bi bi-book"></i>
                  <span>Trường hợp hết thời hạn mượn mà 
                    vẫn cần mượn tài liệu để sử dụng thì bạn đọc đến làm thủ tục gia hạn; trường hợp trả sách quá thời hạn, làm mất sách bạn đọc phải tuân thủ quy định xử lý mượn trả của Nhà trường </span>
                </div>
                <!-- <div class="benefit-item">
                  <i class="bi bi-headset"></i>
                  <span>24/7 customer support available</span>
                </div> -->
              </div>
            </div>
          </div>
        </div>

        <!-- Information Tabs -->
        <div class="row mt-5" data-aos="fade-up" data-aos-delay="300">
          <div class="col-12">
            <div class="info-tabs-container">
              <nav class="tabs-navigation nav">
                <!-- <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ecommerce-product-details-5-overview" type="button">Overview</button> -->
                <!-- <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ecommerce-product-details-5-technical" type="button">Technical Details</button> -->
                <!-- <button class="nav-link" data-bs-toggle="tab" data-bs-target="#ecommerce-product-details-5-customer-reviews" type="button">Reviews (127)</button> -->
                  <button
                      class="nav-link"
                      [class.active]="isReviewActive"
                      (click)="toggleReview()"
                      type="button">
                      Đánh giá ({{ totalReviews }})
                  </button>
              </nav>

              <div class="tab-content">
                <!-- Overview Tab -->
                <!-- <div class="tab-pane fade show active" id="ecommerce-product-details-5-overview">
                  <div class="overview-content">
                    <div class="row g-4">
                      <div class="col-lg-8">
                        <div class="content-section">
                          <h3>Product Overview</h3>
                          <p>Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt. Neque porro quisquam est, qui dolorem ipsum quia dolor sit amet, consectetur, adipisci velit.</p>

                          <h4>Key Highlights</h4>
                          <div class="highlights-grid">
                            <div class="highlight-card">
                              <i class="bi bi-volume-up"></i>
                              <h5>Superior Audio</h5>
                              <p>Ut enim ad minima veniam quis nostrum exercitationem</p>
                            </div>
                            <div class="highlight-card">
                              <i class="bi bi-battery-charging"></i>
                              <h5>Long Battery</h5>
                              <p>Excepteur sint occaecat cupidatat non proident</p>
                            </div>
                            <div class="highlight-card">
                              <i class="bi bi-wifi"></i>
                              <h5>Wireless Tech</h5>
                              <p>Duis aute irure dolor in reprehenderit in voluptate</p>
                            </div>
                            <div class="highlight-card">
                              <i class="bi bi-person-check"></i>
                              <h5>Comfort Fit</h5>
                              <p>Lorem ipsum dolor sit amet consectetur adipiscing</p>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-lg-4">
                        <div class="package-contents">
                          <h4>Package Contents</h4>
                          <ul class="contents-list">
                            <li><i class="bi bi-check-circle"></i>Premium Audio Device</li>
                            <li><i class="bi bi-check-circle"></i>Premium Carrying Case</li>
                            <li><i class="bi bi-check-circle"></i>USB-C Fast Charging Cable</li>
                            <li><i class="bi bi-check-circle"></i>3.5mm Audio Connector</li>
                            <li><i class="bi bi-check-circle"></i>Quick Start Guide</li>
                            <li><i class="bi bi-check-circle"></i>Warranty Documentation</li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div> -->

                <!-- Technical Details Tab -->
                <!-- <div class="tab-pane fade" id="ecommerce-product-details-5-technical">
                  <div class="technical-content">
                    <div class="row g-4">
                      <div class="col-md-6">
                        <div class="tech-group">
                          <h4>Audio Specifications</h4>
                          <div class="spec-table">
                            <div class="spec-row">
                              <span class="spec-name">Frequency Range</span>
                              <span class="spec-value">15Hz - 25kHz</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Driver Diameter</span>
                              <span class="spec-value">50mm Dynamic</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Sensitivity</span>
                              <span class="spec-value">98dB SPL</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Impedance</span>
                              <span class="spec-value">24 Ohm</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">THD</span>
                              <span class="spec-value">&lt; 0.5%</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-6">
                        <div class="tech-group">
                          <h4>Connectivity &amp; Power</h4>
                          <div class="spec-table">
                            <div class="spec-row">
                              <span class="spec-name">Wireless Protocol</span>
                              <span class="spec-value">Bluetooth 5.3</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Range</span>
                              <span class="spec-value">Up to 30ft (10m)</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Battery Capacity</span>
                              <span class="spec-value">800mAh Li-ion</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Usage Time</span>
                              <span class="spec-value">35+ hours</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Charge Time</span>
                              <span class="spec-value">2.5 hours</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-6">
                        <div class="tech-group">
                          <h4>Physical Dimensions</h4>
                          <div class="spec-table">
                            <div class="spec-row">
                              <span class="spec-name">Weight</span>
                              <span class="spec-value">285g</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Dimensions</span>
                              <span class="spec-value">190 x 165 x 82mm</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Ear Cup Material</span>
                              <span class="spec-value">Memory Foam</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Headband</span>
                              <span class="spec-value">Adjustable Steel</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-6">
                        <div class="tech-group">
                          <h4>Advanced Features</h4>
                          <div class="spec-table">
                            <div class="spec-row">
                              <span class="spec-name">Noise Cancellation</span>
                              <span class="spec-value">Hybrid ANC</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Voice Assistant</span>
                              <span class="spec-value">Siri &amp; Google</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Microphone Type</span>
                              <span class="spec-value">Dual Array</span>
                            </div>
                            <div class="spec-row">
                              <span class="spec-name">Water Rating</span>
                              <span class="spec-value">IPX5</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div> -->

                <!-- Reviews Tab -->
                <div *ngIf="isReviewActive">
                  <div class="reviews-content">
                    <div class="reviews-header">
                      <div class="rating-overview">
                          <div class="average-score">
                            <div class="score-display">{{ averageRating || 0 }}</div>

                            <div class="score-stars">
                              <ng-container *ngFor="let i of [1,2,3,4,5]">
                                <i
                                  class="bi"
                                  [ngClass]="{
                                    'bi-star-fill': i <= averageRating,
                                    'bi-star-half': i > averageRating && i - 0.5 <= averageRating,
                                    'bi-star': i-0.5 > averageRating
                                  }"
                                ></i>
                              </ng-container>
                            </div>
                           


                            <div class="total-reviews"> Có {{ totalReviews }} người đánh giá</div>
                        </div>

                        <div class="rating-distribution">
                          <div class="rating-row" *ngFor="let star of [5,4,3,2,1]">
                            <span class="stars-label">{{ star }}★</span>
                            <div class="progress-container">
                              <div
                                class="progress-fill"
                                [style.width]="
                                  totalReviews
                                    ? (ratingCounts[star - 1] / totalReviews) * 100 + '%'
                                    : '0%'
                                "
                              ></div>
                            </div>
                            <span class="count-label">{{ ratingCounts[star - 1] }}</span>
                          </div>
                        </div>
                      </div>



                      <div class="write-review-cta">
                        <h4>Đánh giá của bạn</h4>
                        <p>Hãy cho mọi người biết cảm nhận của bạn về tài liệu này</p>
                         <!-- Dãy sao đánh giá -->
                        <div class="rating-stars mb-3">
                          <i *ngFor="let star of stars; let i = index"
                           class="bi"
                          [ngClass]="i < reviewRating ? 'bi-star-fill' : 'bi-star'"
                          (click)="reviewRating = i + 1"
                          (mouseenter)="hoverRating(i + 1)"
                          (mouseleave)="hoverRating(0)"
                          style="
                            font-size: 2.3rem;     
                            color: gold;
                            cursor: pointer;
                            margin: 0 6px;        
                            transition: transform 0.2s ease;
                        "
                          (mouseover)="hovered = i"
                          (mouseout)="hovered = -1"
                          [style.transform]="hovered === i ? 'scale(1.2)' : 'scale(1)'">
                          </i>
                        </div>
                        <button class="btn review-btn" (click)="toggleWriteReview()">Bình luận</button>
                      </div>
                    </div>
                    <!--Code them vào-->
                   <div *ngIf="showWriteReview" class="write-review-form mt-3 position-relative">
                      <div class="d-flex align-items-start gap-3">
    
                      <!-- Avatar người dùng -->
                        <div class="user-avatar">
                          <img src="assets/img/person/person-f-1.webp" alt="Profile" loading="lazy">
                          <span class="status-badge"><i class="bi bi-shield-check"></i></span>
                        </div>

                        <!-- Ô nhập bình luận -->
                        <div class="flex-grow-1 position-relative">
                          <textarea
                            [(ngModel)]="reviewText"
                            class="form-control"
                            rows="3"
                            placeholder="Viết bình luận...">
                          </textarea>

                          <div class="comment-actions mt-2 d-flex align-items-center mt-2 gap-2">
                            <button class="emoji-btn" (click)="toggleEmojiPicker()">
                              <i class="bi bi-emoji-smile"></i>
                            </button>
                           <!-- Popup emoji -->
                            <div class="emoji-popup" *ngIf="showEmojiPicker">
                              <emoji-mart
                                (emojiSelect)="addEmoji($event)"
                                [showPreview]="false">
                              </emoji-mart>
                            </div>
                            <div class="button-group">
                              <button class="btn btn-primary btn-sm me-2" (click)="submitReview()">Bình luận</button>
                              <button class="btn btn-outline-secondary btn-sm" (click)="cancelWriteReview()">Hủy</button>
                            </div>
                          </div>
                          
                          
                         
                        </div>

                      </div>
                    </div> 


                    <!--Code them vào-->
                    <div class="customer-reviews-list">
                      
                      <!-- Danh sách đánh giá -->
                     


                      <div *ngIf="pagedReviews && pagedReviews.length > 0; else khongCoDanhGia">
                        <div *ngFor="let dg of pagedReviews; index as idx" class="review-card mb-3">
                          <div class="reviewer-profile">
                            <div class="user-avatar">
                              <img src="assets/img/person/person-f-3.webp" alt="Profile">
                              <span class="status-badge">
                                <i class="bi bi-shield-check"></i>
                              </span>
                            </div>

                            <div class="profile-details">
                              <div class="customer-name">{{ dg.hoTen }}</div>
                              <div class="review-meta">
                                <div class="review-stars">
                                  <i *ngFor="let star of stars; index as i"
                                    class="bi"
                                    [ngClass]="i < dg.soSao ? 'bi-star-fill text-warning' : 'bi-star'"></i>
                                </div>
                                <span class="review-date">{{ dg.ngayDg | date:'dd/MM/yyyy' }}</span>
                              </div>
                            </div>
                          </div>

                          <div class="review-text mt-2">
                            <p>{{ dg.binhLuan }}</p>
                          </div>

                          <div class="review-actions mt-2" *ngIf="dg.maDg === currentUserMaDg && isLoggedIn">
                            <button class="btn btn-sm btn-outline-primary me-2" (click)="editReview(idx)">Sửa</button>
                            <button class="btn btn-sm btn-outline-danger" (click)="deleteReview(idx)">Xóa</button>
                          </div>
                        </div>

                          <!--Phân trang-->
                        <section id="category-pagination" class="category-pagination section" *ngIf="totalPages > 1">
                          <div class="container">
                            <nav class="d-flex justify-content-center" aria-label="Page navigation">
                              <ul>
                                <li>
                                  <a href="#" (click)="prevPage(); $event.preventDefault()" aria-label="Previous page">
                                    <i class="bi bi-arrow-left"></i>
                                    <span class="d-none d-sm-inline">Previous</span>
                                  </a>
                                </li>

                                <li *ngFor="let p of visiblePages">
                                  <ng-container *ngIf="p !== '...'; else ellipsis">
                                    <a href="#" [class.active]="p === currentPage"
                                      (click)="onPageClick(p, $event)">
                                      {{ p }}
                                    </a>
                                  </ng-container>
                                  <ng-template #ellipsis>
                                    <span class="ellipsis">...</span>
                                  </ng-template>
                                </li>

                                <li>
                                  <a href="#" (click)="nextPage(); $event.preventDefault()" aria-label="Next page">
                                    <span class="d-none d-sm-inline">Next</span>
                                    <i class="bi bi-arrow-right"></i>
                                  </a>
                                </li>
                              </ul>
                            </nav>
                          </div>
                        </section>




                        </div>

                        <ng-template #khongCoDanhGia>
                          <p class="text-muted fst-italic">Chưa có đánh giá nào cho sách này.</p>
                        </ng-template>

                          
                      
                      <!-- <div class="review-card">
                        <div class="reviewer-profile">
                          <div class="user-avatar">
                            <img src="assets/img/person/person-f-3.webp" alt="Profile">
                            <span class="status-badge">
                              <i class="bi bi-shield-check"></i>
                            </span>
                          </div>

                          <div class="profile-details">
                            <div class="customer-name">Sarah Martinez</div>
                            <div class="review-meta">
                              <div class="review-stars">
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                              </div>
                              <span class="review-date">March 28, 2024</span>
                            </div>
                          </div>
                        </div>
                        <h5 class="review-headline">Outstanding audio quality and comfort</h5>
                        <div class="review-text">
                          <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam. Eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
                        </div>
                        <div class="review-actions">
                          <button class="action-btn"><i class="bi bi-hand-thumbs-up"></i> Helpful (12)</button>
                          <button class="action-btn"><i class="bi bi-chat-dots"></i> Reply</button>
                        </div>
                      </div> -->

                      

                      

                      
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section><!-- /Product Details Section -->
</main>
