<main class="main">
<!-- Page Title -->
    <div class="page-title light-background">
      <div class="container d-lg-flex justify-content-between align-items-center">
        <h1 class="mb-2 mb-lg-0">Chi tiết sách</h1>
        <nav class="breadcrumbs">
          <ol>
            <li><a routerLink="/" routerLinkActive="active">Home</a></li>
            <li class="current">Product Details</li>
          </ol>
        </nav>
      </div>
    </div><!-- End Page Title -->

    <!-- Product Details Section -->
    <section id="product-details" class="product-details section">

      <div class="container" data-aos="fade-up" data-aos-delay="100">

        <div class="row g-4">
          <!-- Product Gallery -->
          <div class="col-lg-7" data-aos="zoom-in" data-aos-delay="150">
            <div class="product-gallery">
              <div class="main-showcase">
                <div class="image-zoom-container">
                  <img [src]="getImageUrl(sach?.maSach, 'jpg')"
                      alt="{{ sach?.tuaSach }}"
                      class="img-fluid main-product-image"
                      id="main-product-image"
                      [attr.data-zoom]="getImageUrl(sach?.maSach ?? 0, 'jpg')">
                </div>
              </div>
            </div>
          </div>

          <!-- Product Details -->
          <div class="col-lg-5" data-aos="fade-left" data-aos-delay="200">
            <div class="product-details">
              <div class="product-badge-container">
                <!-- <span class="badge-category">Audio Equipment</span> -->
                <div class="rating-group">
                  <div class="stars">
                    <ng-container *ngFor="let i of [1,2,3,4,5]">
                      <i
                        class="bi"
                        [ngClass]="{
                          'bi-star-fill': i <= averageRating,
                          'bi-star-half': i > averageRating && i - 0.5 <= averageRating,
                          'bi-star': i-0.5 > averageRating
                        }"
                      ></i>
                    </ng-container>
                  </div>
                  <span class="review-text">({{ totalReviews }} đánh giá)</span>
                </div>
              </div>

              <h1 class="product-name">{{ sach?.tuaSach }}</h1> 

              <div class="pricing-section">
                <div class="price-display">
                  <span class="sale-price">{{ sach?.tenTg }}</span>
                </div>
                <div class="savings-info">
                </div>
              </div>

              <div class="product-description">
                 <p>{{ sach?.gioiThieu }}</p>
              </div> 

              <div class="availability-status">
                <div class="stock-indicator">
                  <i class="bi bi-check-circle-fill"></i>
                  <span class="stock-text">Số sách còn</span>
                </div>
                <div class="quantity-left">Chỉ còn {{ sach?.soLuong }} quyển</div>
              </div>
              <div class="purchase-section">
                <div class="quantity-control">
                  <label class="control-label">Số lượng:</label>
                    <div class="quantity-input-group">
                      <div class="quantity-selector">
                        <button class="quantity-btn decrease" type="button" (click)="decreaseQuantity()">
                            <i class="bi bi-dash"></i>
                        </button>
                        <input type="number"
                           class="quantity-input no-arrow"
                           [(ngModel)]="quantity"
                           min="1"
                           max="sach?.soLuong">
                        <button class="quantity-btn increase" type="button" (click)="increaseQuantity()">
                             <i class="bi bi-plus"></i>
                        </button>
                      </div>
                    </div>
                </div>
                <div class="action-buttons">
                  <button class="btn secondary-action" [disabled]="sach?.soLuong==0" (click)="placeOrder()">
                    <i class="bi bi-book"></i>
                    Đặt sách
                  </button>
                </div>
              </div>

              <!-- Benefits List -->
              <div class="benefits-list">
                <div class="benefit-item">
                 <i class="bi bi-book"></i>
                  <span>Đối tượng mượn là sinh viên, giảng viên đã đăng ký thẻ độc giả</span>
                </div>
                <div class="benefit-item">
                  <i class="bi bi-book"></i>
                  <span>Kiểm tra kỹ tình trạng tài liệu và báo cáo cho cán bộ thư viện nếu tài liệu bị rách, bị bẩn… trước khi mượn </span>
                </div>
                <div class="benefit-item">
                  <i class="bi bi-book"></i>
                  <span>Trường hợp hết thời hạn mượn mà 
                    vẫn cần mượn tài liệu để sử dụng thì bạn đọc đến làm thủ tục gia hạn; trường hợp trả sách quá thời hạn, làm mất sách bạn đọc phải tuân thủ quy định xử lý mượn trả của Nhà trường </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Information Tabs -->
        <div class="row mt-5" data-aos="fade-up" data-aos-delay="300">
          <div class="col-12">
            <div class="info-tabs-container">
              <nav class="tabs-navigation nav">
                  <button
                      class="nav-link"
                      [class.active]="isReviewActive"
                      (click)="toggleReview()"
                      type="button">
                      Đánh giá ({{ totalReviews }})
                  </button>
              </nav>

              <div class="tab-content">

                <!-- Reviews Tab -->
                <div *ngIf="isReviewActive">
                  <div class="reviews-content">
                    <div class="reviews-header">
                      <div class="rating-overview">
                          <div class="average-score">
                            <div class="score-display">{{ averageRating || 0 }}</div>
                            <div class="score-stars">
                              <ng-container *ngFor="let i of [1,2,3,4,5]">
                                <i
                                  class="bi"
                                  [ngClass]="{
                                    'bi-star-fill': i <= averageRating,
                                    'bi-star-half': i > averageRating && i - 0.5 <= averageRating,
                                    'bi-star': i-0.5 > averageRating
                                  }"
                                ></i>
                              </ng-container>
                            </div>
                            <div class="total-reviews"> Có {{ totalReviews }} người đánh giá</div>
                        </div>
                        <div class="rating-distribution">
                          <div class="rating-row" *ngFor="let star of [5,4,3,2,1]">
                            <span class="stars-label">{{ star }}★</span>
                            <div class="progress-container">
                              <div
                                class="progress-fill"
                                [style.width]="
                                  totalReviews
                                    ? (ratingCounts[star - 1] / totalReviews) * 100 + '%'
                                    : '0%'
                                "
                              ></div>
                            </div>
                            <span class="count-label">{{ ratingCounts[star - 1] }}</span>
                          </div>
                        </div>
                      </div>
                      <div class="write-review-cta">
                        <h4>Đánh giá của bạn</h4>
                        <p>Hãy cho mọi người biết cảm nhận của bạn về tài liệu này</p>
                         <!-- Dãy sao đánh giá -->
                        <div class="rating-stars mb-3">
                          <i *ngFor="let star of stars; let i = index"
                           class="bi"
                          [ngClass]="i < reviewRating ? 'bi-star-fill' : 'bi-star'"
                          (click)="reviewRating = i + 1"
                          (mouseenter)="hoverRating(i + 1)"
                          (mouseleave)="hoverRating(0)"
                          style="
                            font-size: 2.3rem;     
                            color: gold;
                            cursor: pointer;
                            margin: 0 6px;        
                            transition: transform 0.2s ease;
                        "
                          (mouseover)="hovered = i"
                          (mouseout)="hovered = -1"
                          [style.transform]="hovered === i ? 'scale(1.2)' : 'scale(1)'">
                          </i>
                        </div>
                        <button class="btn review-btn" (click)="toggleWriteReview()">Bình luận</button>
                      </div>
                    </div>
                    <!--Code them vào-->
                   <div *ngIf="showWriteReview" class="write-review-form mt-3 position-relative">
                      <div class="d-flex align-items-start gap-3">
    
                      <!-- Avatar người dùng -->
                        <div class="user-avatar">
                          <img src="assets/img/person/person-f-1.webp" alt="Profile" loading="lazy">
                          <span class="status-badge"><i class="bi bi-shield-check"></i></span>
                        </div>

                        <!-- Ô nhập bình luận -->
                        <div class="flex-grow-1 position-relative">
                          <textarea
                            [(ngModel)]="reviewText"
                            class="form-control"
                            rows="3"
                            placeholder="Viết bình luận...">
                          </textarea>

                          <div class="comment-actions mt-2 d-flex align-items-center gap-2">
                            <div class="emoji-wrapper">
                               <button class="emoji-btn" (click)="toggleEmojiPicker($event)">
                                 <i class="bi bi-emoji-smile"></i>
                               </button>
                           <!-- Popup emoji -->
                               <div class="emoji-popup" *ngIf="showEmojiPicker" [ngStyle]="emojiPopupStyle"> 
                                 <emoji-mart
                                    (emojiSelect)="addEmoji($event)"
                                    [showPreview]="false">
                                 </emoji-mart>
                               </div>
                            </div>
                            <div class="button-group">
                              <button class="btn btn-primary btn-sm me-2" (click)="submitReview()">Bình luận</button>
                              <button class="btn btn-outline-secondary btn-sm" (click)="cancelWriteReview()">Hủy</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div> 


                    <!--Code them vào-->
                    <div class="customer-reviews-list">

                      <div *ngIf="pagedReviews && pagedReviews.length > 0; else khongCoDanhGia">
                        <div *ngFor="let dg of pagedReviews; index as idx" class="review-card mb-3">
                          <div class="reviewer-profile">
                            <div class="user-avatar">
                              <img src="assets/img/person/person-f-3.webp" alt="Profile">
                              <span class="status-badge">
                                <i class="bi bi-shield-check"></i>
                              </span>
                            </div>

                            <div class="profile-details">
                              <div class="customer-name">{{ dg.hoTen }}</div>
                              <div class="review-meta">
                                <div class="review-stars">
                                  <i *ngFor="let star of stars; index as i"
                                    class="bi"
                                    [ngClass]="i < dg.soSao ? 'bi-star-fill text-warning' : 'bi-star'"></i>
                                </div>
                                <span class="review-date">{{ dg.ngayDg | date:'dd/MM/yyyy' }}</span>
                              </div>
                            </div>
                          </div>

                          <div class="review-text mt-2">
                            <p>{{ dg.binhLuan }}</p>
                          </div>

                          <div class="review-actions mt-2" *ngIf="dg.maDg === currentUserMaDg && isLoggedIn">
                            <button class="btn btn-sm btn-outline-primary me-2" (click)="editReview(idx)">Sửa</button>
                            <button class="btn btn-sm btn-outline-danger" (click)="deleteReview(idx)">Xóa</button>
                          </div>
                        </div>
                          <!--Phân trang-->
                        <section id="category-pagination" class="category-pagination section" *ngIf="totalPages > 1">
                          <div class="container">
                            <nav class="d-flex justify-content-center" aria-label="Page navigation">
                              <ul>
                                <li>
                                  <a href="#" (click)="prevPage(); $event.preventDefault()" aria-label="Previous page">
                                    <i class="bi bi-arrow-left"></i>
                                    <span class="d-none d-sm-inline">Previous</span>
                                  </a>
                                </li>

                                <li *ngFor="let p of visiblePages">
                                  <ng-container *ngIf="p !== '...'; else ellipsis">
                                    <a href="#" [class.active]="p === currentPage"
                                      (click)="onPageClick(p, $event)">
                                      {{ p }}
                                    </a>
                                  </ng-container>
                                  <ng-template #ellipsis>
                                    <span class="ellipsis">...</span>
                                  </ng-template>
                                </li>

                                <li>
                                  <a href="#" (click)="nextPage(); $event.preventDefault()" aria-label="Next page">
                                    <span class="d-none d-sm-inline">Next</span>
                                    <i class="bi bi-arrow-right"></i>
                                  </a>
                                </li>
                              </ul>
                            </nav>
                          </div>
                        </section>
                        </div>
                        <ng-template #khongCoDanhGia>
                          <p class="text-muted fst-italic">Chưa có đánh giá nào cho sách này.</p>
                        </ng-template>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
</main>
